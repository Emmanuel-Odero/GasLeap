# Development Dockerfile for GasLeap
# This container includes all development tools for testing and building
FROM rust:1.82

# Install system dependencies
RUN apt-get update && apt-get install -y \
    clang \
    libclang-dev \
    cmake \
    build-essential \
    git \
    curl \
    pkg-config \
    libssl-dev \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# Install additional Rust components
RUN rustup component add rustfmt clippy
RUN rustup target add wasm32-unknown-unknown

# Set working directory
WORKDIR /workspace

# Copy Cargo files first for better caching
COPY Cargo.toml ./
COPY pallets/sponsorship/Cargo.toml ./pallets/sponsorship/
COPY runtime/Cargo.toml ./runtime/
COPY node/Cargo.toml ./node/

# Create dummy source files to build dependencies
RUN mkdir -p pallets/sponsorship/src runtime/src node/src && \
    echo "fn main() {}" > node/src/main.rs && \
    echo "pub fn add(left: usize, right: usize) -> usize { left + right }" > pallets/sponsorship/src/lib.rs && \
    echo "pub fn add(left: usize, right: usize) -> usize { left + right }" > runtime/src/lib.rs

# Build dependencies
RUN cargo build --release
RUN rm -rf pallets/sponsorship/src runtime/src node/src

# Copy the actual source code
COPY . .

# Set environment variables for development
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1

# Default command for development
CMD ["bash"]